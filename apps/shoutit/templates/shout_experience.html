{% extends "base.html" %}
{% load widget_tweaks %}
{% load template_filters %}

{% block styles %}
    <link rel="stylesheet" type="text/css" href="/static/css/fileuploader.css" />
{% endblock %}

{% block content %}
	<div style="margin-bottom: 18px;" class="span6 offset6 clearfix unselectable">
		<a class="btn" href="/shout/buy">Buying</a>
		<a class="btn" href="/shout/sell">Selling</a>
		<a class="btn disabled" href="/shout/exp/">Experience</a>
	</div>

    <div class="span12 offset2">
        <form enctype="multipart/form-data" method="post" id="store_shout_experience">
            {% csrf_token %}

            <div class="clearfix {% if form.store_id.errors %}error{% endif %}">
                <label>What store are you shouting about?</label>
                <div class="input">
                    {{ form.store_id|attr:"class:xlarge" }}{% if form.store_id.errors %}{% for error in form.store_id.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                </div>
            </div>

            <div class="clearfix {% if form.description.errors %}error{% endif %}">
                <label>Describe it here</label>
                <div class="input">
                    {{ form.description|attr:"class:xlarge" }}{% if form.description.errors %}{% for error in form.description.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                </div>
            </div>

            <div class="clearfix {% if form.tags.errors %}error{% endif %}">
                <label>Tags</label>
                <div class="input">
                    {{ form.tags|attr:"class:xlarge" }}{% if form.tags.errors %}{% for error in form.tags.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                    <span id="tags_max">please input only 5 tags</span>
                </div>
            </div>

            <div class="clearfix {% if form.image.errors %}error{% endif %}">
                <label>Images</label>
                <div class="input" id="file-uploader">
                    <noscript>
                        <p>Please enable JavaScript to use file uploader.</p>
                    </noscript>
                </div>
            </div>

            <div>
                <label>Location</label>
                <div class="input" id="store_shout_experience_map" style="width: 280px; height: 280px;">
                </div>
            </div>

            <div>
                <div class="input">
                    {{ form.location|attr:"style:visibility:hidden" }}
{#                    {{ form.country|attr:"style:visibility:hidden" }}#}
{#                    {{ form.city|attr:"style:visibility:hidden" }}#}
{#                    {{ form.address|attr:"style:visibility:hidden" }}#}
                </div>
            </div>

            <div class="actions">
        {#                <button class="btn shout_sell">Shout!</button>#}
                <button id="shout_experience" class="btn shout_experience unselectable" type="submit">Shout!</button>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
	{% block sub_scripts %}{% endblock %}
	<script type="text/javascript">
		$(document).ready(function () {
            CreateShoutMap("store_shout_experience_map");
            $('form#store_shout_experience').submitAjaxily(function (data) {
                setTimeout("window.location = '" + data.data.next + "';", 1500);
            });

            var uploader = new qq.FileUploader({
                action: "/upload/shout_experience/",
                element: $('#file-uploader')[0],
                multiple: true,
                onComplete: function( id, fileName, responseJSON ) {
                    $('#ajax_loading').hide();
                    if (responseJSON.success) {
                        var img = $('<img src="' + responseJSON.url + '" title="' + fileName + '" alt="' + fileName + '" />');
                        img.load(function () {
                            var w = this.clientWidth;
                            var h = this.clientHeight;
                            if (w > h) {
                                ratio = w / 100;
                                h = h / ratio;
                                w = 100;
                            } else {
                                ratio = h / 100;
                                w = w / ratio;
                                h = 100;
                            }
                            $(this).css('width', '' + w + 'px');
                            $(this).css('height', '' + h + 'px');
                        });
                        $('#file-uploader').parents('div').filter(':first').append('<p></p>').append(img);
                        $('form#store_shout_experience').append('<input type="hidden" value="' + responseJSON.url + '" name="shout_images"/>');
                    }
                },
                params: {
                  'csrf_token': '{% csrf_token_value %}',
                  'csrf_name': 'csrfmiddlewaretoken',
                  'csrf_xname': 'X-CSRFToken'
                },
                onSubmit: function(id, fileName){
                    $('#ajax_loading').show();
                },
                allowedExtensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp'],
                sizeLimit: 1024 * 1024
            });

            $('#id_tags').tagsInput({
				autocomplete_url:'/xhr/search/tag/',
				autocomplete:{
					autoFocus:true, minLength:1, delay:300,
					source: function(request, response) {
						$.ajax({
							url: "/xhr/search/tag/",
							dataType: "json",
							data: {
								term: request.term
							},
							success: function(data) {
								//map the data into a response that will be understood by the autocomplete widget
								data = data.data
								response($.map(data, function(item) {
									return {
										label: item,
										value: item
									}
								}));
							}
						});
					}
				}
				,
				'height':'72px',
				'width':'270px',
				'interactive':true,
				'delimiter': [' ',','],//first SHOULD always be ' ' [space]
				'defaultText':'add a tag',
				'onAddTag':null,
				'onRemoveTag':null,
				'onChange' : null,
				'removeWithBackspace' : true,
				'minChars' : 2,
				'maxChars' : 30, //if not provided there is no limit,
				'placeholderColor' : '#808080',
				max_tags:5
            });
        });
	</script>
{% endblock %}