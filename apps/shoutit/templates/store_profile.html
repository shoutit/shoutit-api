{% extends 'base.html' %}
{% load widget_tweaks %}
{% load staticfiles %}

{% block styles %}
{% endblock %}


{% block content %}

	<div class="modal hide fade in" id="FollowersModal">
		<div class="modal-header">
			<a href="#" class="close">Ã—</a>
			<h4>{{ storeProfile.Name }} Followers </h4>
		</div>
		<div id="FollowersModalContain" class="modal-body">
		</div>
		<div class="modal-footer">
		</div>
	</div>

{#	left column#}
	<div class="span3">
		<div class="shout_store_image clearfix">
			<img src="/xhr/store/{{ storeProfile.pk }}/picture/160/" alt="{{ storeProfile.Name }}">
		</div>
        <div class="shout_user_tags clearfix">
            <h5>Owned by</h5>
            {% if storeProfile.Owner %}
                <a class="btn large user_thumb" href="/user/{{ storeProfile.Owner.username }}/"><img src="/xhr/user/{{ storeProfile.Owner.username }}/picture/32"><span>{{ storeProfile.Owner.username }}</span></a>
            {% endif %}
        </div>
{#        <div class="shout_user_badges clearfix">#}
{#			<h5>{{ storeProfile.Name }} badges</h5>#}
{#			<ul class="unstyled">#}
{#			{%  for badge in user_profile.Badges.all %}#}
{#				<li><a class="user_badge clearfix unselectable">{{ badge.Name }}</a></li>#}
{#			{% endfor %}#}
{#			</ul>#}
{#		</div>#}
    </div>

    <div class="span9">
		<div class="clearfix">
			<div class="lfloat">
				<h1>{{ storeProfile.Name }}</h1>
			</div>
			<div class="lfloat">
				{% if storeProfile.Owner == request.user %}
					<a id="" class="btn disabled follow-unfollow unselectable">This is yours</a>
				{% else%}
					{% if storeProfile.Stream in request.user.Profile.Following.all %}
						<a id="unfollow" class="btn success follow-unfollow unselectable">Following</a>
					{% else  %}
						<a id="follow" class="btn info follow-unfollow unselectable">Follow</a>
					{% endif %}
				{% endif %}
			</div>
		</div>

		<div class="shout_user_info well">
			{{ storeProfile.Description }}
		</div>
        {% if form %}
        <form enctype="multipart/form-data" method="post" action="" id="store_shout_sell">
            {% csrf_token %}

            <div class="clearfix {% if form.name.errors %}error{% endif %}">
                <label>I'm selling<br/><small>What are you shouting about?</small></label>
                <div class="input">
                    {{ form.name|attr:"class:xlarge" }}{% if form.name.errors %}{% for error in form.name.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                </div>
            </div>

            <div class="clearfix {% if form.price.errors %}error{% endif %}">
                <label>For</label>
                <div class="input">
                    {{ form.price|attr:"class:mini" }}{% if form.price.errors %}{% for error in form.price.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                </div>
            </div>

            <div class="clearfix {% if form.description.errors %}error{% endif %}">
                <label>Describe it here</label>
                <div class="input">
                    {{ form.description|attr:"class:xlarge" }}{% if form.description.errors %}{% for error in form.description.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                </div>
            </div>

            <div class="clearfix {% if form.tags.errors %}error{% endif %}">
                <label>Tags</label>
                <div class="input">
                    {{ form.tags|attr:"class:xlarge" }}{% if form.tags.errors %}{% for error in form.tags.errors %}<span > {{ error }}</span>{% endfor %}{% endif %}
                    <span id="tags_max">please input only 5 tags</span>
                </div>
            </div>

            <div class="clearfix {% if form.image.errors %}error{% endif %}">
                <label>Image</label>
                <div class="input">
                    {{ form.image|attr:"style:width: 270px;" }}{% if form.image.errors %}{% for error in form.image.errors %}<span>{{ error }}</span>{% endfor %}{% endif %}
                </div>
            </div>

            <div>
                <label>Location</label>
                <div class="input" id="store_shout_sell_map" style="width: 280px; height: 280px;">
                    <script>load("buy", "store_shout_sell_map");</script>
                </div>
            </div>

            <div>
                <label></label>
                <div class="input">
                    {{ form.location|attr:"style:visibility:hidden" }}
                </div>
            </div>



            <div class="actions">
{#                <button class="btn shout_sell">Shout!</button>#}
                <button id="shout_sell" class="btn shout_sell unselectable" type="submit">Shout!</button>
            </div>

        </form>
        {% endif %}

		<div class="stream">
			<h4>Shout Stream</h4>
			{% include 'stream.html' %}
		</div>
	</div>

    <div class="span4">
		<div class="clearfix">

			<div id="control_btns" class="clearfix">
            {% if request.user.Profile == storeProfile.Owner.Profile  %}   <a class="btn rfloat" href="./edit"> Edit Profile </a> {% endif %}
            </div>

			<div id="stats_summary" class="clearfix">
				<h5>Store Stats</h5>
				<a class="btn large disabled"><span class="count">{{ storeProfile.Shouts.count }}</span> <small>shouts</small></a>
				<a id="aFollowers" class="btn large " data-controls-modal="FollowersModal" data-backdrop="static"><span class="count">{{ storeProfile.Stream.userprofile_set.count }}</span> <small>Followers</small></a>
				<a class="btn large disabled"><span class="count">{{ storeProfile.ExperiencesCounter }}</span> <small>Mentions</small></a>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}
	{% block sub_scripts %}{% endblock %}
    <script src="{% static "js/jquery-ui-1.8.16.custom.min.js"%}"></script>
    <script src="{% static "js/jquery.tagsinput.min.js"%}"></script>
	<script type="text/javascript">
		$(document).ready(function () {
            fix_stream();

            register_stream('/xhr/store/{{ storeProfile.pk }}/stream/', '.stream');

			$('.follow-unfollow').click(follow_unfollow);
			$('.follow-unfollow').hover(following_hover_on,following_hover_off);

            $('#store_shout_sell').click(store_shout_sell);

            $('#FollowersModal').modal({
                keyboard: true ,
                backdrop: true
            });
             $('#aFollowers').click(loadFollowers);

            $('#id_tags').tagsInput({
				autocomplete_url:'/xhr/search/tag/',
				autocomplete:{
					autoFocus:true, minLength:1, delay:300,
					source: function(request, response) {
						$.ajax({
							url: "/xhr/search/tag/",
							dataType: "json",
							data: {
								term: request.term
							},
							success: function(data) {
								//map the data into a response that will be understood by the autocomplete widget
								data = data.data
								response($.map(data, function(item) {
									return {
										label: item,
										value: item
									}
								}));
							}
						});
					}
				}
				,
				'height':'72px',
				'width':'270px',
				'interactive':true,
				'delimiter': [' ',','],//first SHOULD always be ' ' [space]
				'defaultText':'add a tag',
				'onAddTag':null,
				'onRemoveTag':null,
				'onChange' : null,
				'removeWithBackspace' : true,
				'minChars' : 2,
				'maxChars' : 30, //if not provided there is no limit,
				'placeholderColor' : '#808080',
				max_tags:5
            });
        });


		var FollowersLoaded = false;
        function loadFollowers(){
            if(FollowersLoaded)
				return;
			requestAjaxily({
				url: '/xhr/store/{{ storeProfile.id }}/stats/followers/',
                successCallback: function (data) {
                    FollowersLoaded = true;
					var followers =  data.data.followers;
					var html = '';
					html+= '<div class="clearfix">';
                    for(var i = 0;i<followers.length; i++){
                        html+= '<a class="btn large user_thumb" href="/user/'+followers[i]+'"><img src="/xhr/user/'+followers[i]+'/picture/32"><span>' + followers[i] + '</span></a>'
                    }
					$('#FollowersModalContain').append(html);
                }
            });
        }

		function following_hover_on(){
			if($('.follow-unfollow').attr('id')=='unfollow')
				$('.follow-unfollow').html('Unfollow').removeClass('success').addClass('error');
		}
		function following_hover_off(){
			if($('.follow-unfollow').attr('id')=='unfollow')
				$('.follow-unfollow').html('Following').removeClass('error').addClass('success');
		}

		function follow_unfollow(){
			if($('.follow-unfollow').attr('id')=='follow'){
				follow();
			}else if($('.follow-unfollow').attr('id')=='unfollow'){
				unfollow();
			}

		}

		function follow(){
            requestAjaxily({
                url: '/xhr/store/{{ storeProfile.id }}/follow/',
                successCallback: function (data) {
                    $('.follow-unfollow').html('Following').removeClass('info').addClass('success').attr('id','unfollow');
					var counter = $('#aFollowers .count');
					counter.html(parseInt(counter.html())+1);
					FollowersLoaded = false;
                },
                tag: 'follow_store'
            });
		}

		function unfollow(){
            requestAjaxily({
                url: '/xhr/store/{{ storeProfile.id }}/unfollow/',
                successCallback: function (data) {
                    $('.follow-unfollow').html('Follow').removeClass('success').addClass('info').attr('id','follow');
					var counter = $('#aFollowers .count');
					counter.html(parseInt(counter.html())-1);
					FollowersLoaded = false;
                },
                tag: 'unfollow_store'
            });
		}

        function store_shout_sell(){
            $.ajax({
                url : '/xhr/store/{{ storeProfile.id }}/post/',
                type : 'POST',
                data : $('#store_shout_sell').serializeObject(),
                success: function(data) {
                    if (data.code == 0) {

                    } else if (data.code == 1) {

                    } else if (data.code == 3) {
                        redirectToLoginPage(data.data['link'], data.message);
                    }
                }
            });
            return false;
        }

        function store_shout_experience(){
            $.ajax({
                url : '/xhr/store/{{ storeProfile.id }}/exp/',
                type : 'POST',
                data : $('#store_shout_experience').serializeObject(),
                success: function(data) {
                }
            });
            return false;
        }

	</script>
{% endblock %}